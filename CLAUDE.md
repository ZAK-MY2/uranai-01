# CLAUDE.md - COSMIC ORACLE プロジェクト開発ガイド

このドキュメントは、COSMIC ORACLE（uranai-01）プロジェクト専用の開発ガイドラインです。

## 📍 プロジェクトコンテキスト

### プロジェクト概要
- **名前**: COSMIC ORACLE (uranai-01)
- **目標**: 10占術統合 + リアルタイム環境データ連携による高精度AI占いシステム
- **技術スタック**: Next.js 15 + Supabase + TypeScript + Tailwind CSS
- **開発期間**: 12週間（3フェーズ）

### 現在の状況
- **Phase**: 1 (MVP基盤開発)
- **完了**: 
  - 仕様書設計、開発ログシステム確立
  - コズミックUIダッシュボード実装
  - 占術モックデータシステム構築
  - 公共API環境データ取得機能
  - 3占術インフォグラフィックページ（数秘術、タロット、占星術）
- **次の目標**: 残り7占術の詳細ページ、統合占術システム

## 🔧 開発環境

### 開発コマンド
```bash
# 開発サーバー起動
npm run dev

# ビルド
npm run build

# 型チェック（実装予定）
npm run type-check

# リント
npm run lint

# テスト（実装予定）
npm run test
```

### 忘却防止システム
```bash
# 開発開始時（必須）
./scripts/claude-reminder-system.sh start

# 2時間おき通知受信時（必須）
./scripts/claude-context-restore.sh basic

# 開発終了時
./scripts/claude-reminder-system.sh stop
```

### 必要な環境変数
```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# 外部API（段階的に追加）
OPENWEATHER_API_KEY=your_openweather_key
SWISS_EPHEMERIS_API_KEY=your_ephemeris_key
NASA_API_KEY=your_nasa_key
```

## 📋 COSMIC ORACLE 専用開発プロセス

### 🎯 必須：開発ログ記録

**毎回の開発作業で必ず実行すること**

#### 1. 作業開始時
```bash
# 前回の状況確認
cat docs/logs/2025-06/21-cosmic-oracle-specification-design.md
```

#### 2. 作業中
- TodoWriteで進捗管理
- 重要な決定・問題・解決策をメモ

#### 3. 作業完了時（必須）
以下のタイミングで必ず開発ログを作成：
- [ ] 新機能実装完了
- [ ] 重要なバグ修正
- [ ] アーキテクチャ決定
- [ ] マイルストーン達成
- [ ] 学習・洞察獲得

#### ログファイル命名規則
```
docs/logs/YYYY-MM/DD-[作業内容].md

例:
- 21-database-schema-implementation.md
- 22-numerology-engine-development.md
- 23-cosmic-dashboard-implementation.md
```

#### ログテンプレート
```markdown
# YYYY-MM-DD: [作業内容タイトル]

## 実装内容
- 何を実装したか
- なぜその方法を選んだか

## 技術的詳細
- 使用した技術・ライブラリ
- アーキテクチャの決定事項
- コード構造・ファイル配置

## 課題と解決
- 直面した問題
- 解決方法
- 学んだこと

## テスト・検証
- 実行したテスト
- 動作確認方法
- 残課題

## 次のステップ
- 残作業
- 改善案
- 次回の優先事項

---
**作業時間**: XX時間
**次回作業**: XXX
**優先度**: 高/中/低
```

### 🔮 占術システム開発の原則

#### アーキテクチャガイドライン
1. **段階的実装**: 数秘術 → タロット → 西洋占星術 → その他
2. **型安全性**: すべての占術計算でTypeScript型定義
3. **キャッシュ設計**: 同一入力の再計算を避ける
4. **エラーハンドリング**: 外部API障害時のグレースフル対応

#### 品質保証
```bash
# 開発時の必須チェック
npm run lint        # コード品質
npm run build       # ビルド確認
npm run type-check  # 型チェック（実装後）
npm run test        # テスト実行（実装後）
```

#### データベース設計原則
- **RLS (Row Level Security)**: 全テーブルで有効化
- **JSON型活用**: 占術結果・環境データの柔軟な保存
- **インデックス**: クエリパフォーマンス最適化
- **キャッシュテーブル**: 計算結果の高速取得

### 🌍 環境データ連携ガイドライン

#### API統合順序
1. **Phase 1**: OpenWeatherMap（天候）、Lunar API（月相）
2. **Phase 2**: NASA（天体位置）、NOAA（地磁気・潮汐）
3. **Phase 3**: USGS（地震）、太陽活動データ

#### フォールバック戦略
- 複数APIソースの用意
- キャッシュデータによる継続サービス
- エラー時のユーザー体験設計

### 🎨 UI/UX 特別要件

#### 占いアプリ特有の配慮
- **神秘的な雰囲気**: ダークテーマ、宇宙・星座モチーフ
- **レスポンシブ**: モバイルファースト（占い利用の多くはスマホ）
- **読みやすさ**: 占術結果の長文表示に最適化
- **プライバシー**: 個人情報（生年月日等）の慎重な扱い

#### デザイン原則（2025-06-23決定）
- **余白の美学**: Kyuujitsu風の広い余白で宇宙の広大さを表現
- **ゆっくりアニメーション**: 20-40秒サイクルの穏やかな浮遊効果
- **透明感**: 枠線なし、ガラスモーフィズム
- **柔らかいフォント**: 游ゴシック系で優しい印象

#### アニメーション
- カードシャッフル（タロット）
- 星座・惑星の動的表示（占星術）
- 数字カウントアップ（数秘術）
- 背景の宇宙雲（45秒サイクル）
- カードの浮遊（20-40秒サイクル）

### 📊 開発マイルストーン

#### Phase 1: MVP基盤 (Week 1-4)
- [x] Week 1: 仕様書・ログシステム確立
- [ ] Week 2: データベーススキーマ + 数秘術エンジン
- [ ] Week 3: タロットエンジン + 基本UI
- [ ] Week 4: 統合システム + デプロイ

#### Phase 2: 拡張機能 (Week 5-8)
- [ ] Week 5-6: 西洋占星術エンジン
- [ ] Week 7: 環境データ連携
- [ ] Week 8: UI/UX改善・レスポンシブ対応

#### Phase 3: 商用機能 (Week 9-12)
- [ ] Week 9-10: 残り占術（7種類）実装
- [ ] Week 11: 多言語化・国際化
- [ ] Week 12: 最終テスト・本番リリース

### 🚨 重要な注意事項

#### セキュリティ
- **APIキー**: サーバーサイドのみで使用
- **個人情報**: 暗号化・匿名化の徹底
- **占術結果**: 機密性への配慮

#### パフォーマンス
- **計算処理**: 重い処理はキャッシュ活用
- **外部API**: レート制限・タイムアウト対応
- **画像**: 最適化・CDN活用

#### 法的・倫理的配慮
- **免責事項**: 占い結果に対する適切な表現
- **GDPR**: EU圏のプライバシー規制対応
- **各国の占い業規制**: 必要に応じて調査・対応

## 🔄 継続的改善

### 開発パターンの学習
- 成功した実装パターンの記録
- 失敗・問題の分析と対策
- 効率的なワークフローの確立

### ユーザーフィードバック
- MVP公開後のユーザーテスト
- 占術精度の検証・改善
- UI/UX改善点の特定

### 技術的負債管理
- リファクタリングの定期実行
- パフォーマンス改善の継続
- セキュリティアップデートの適用

---

## 📚 参考リソース

### 占術関連
- 数秘術: ピタゴラス式計算方法
- タロット: ライダー・ウェイト版78枚
- 西洋占星術: プラシダス・ハウスシステム

### 技術ドキュメント
- [Next.js 15 Documentation](https://nextjs.org/docs)
- [Supabase Documentation](https://supabase.com/docs)
- [PRODUCTION_SPEC.md](./PRODUCTION_SPEC.md) - 詳細技術仕様

### 開発ログ
- [docs/logs/](./docs/logs/) - 全開発ログアーカイブ

---

**重要**: このガイドラインに従って、必ず開発ログを記録し、プロジェクトの知識を蓄積してください。継続的な記録が成功の鍵です。

**更新履歴**
- 2025-06-23: 包括的ダッシュボード実装完了
  - コズミックUIの本番適用
  - 占術モックデータシステム構築
  - 公共API（気象庁）による環境データ取得
  - 3占術のインフォグラフィック詳細ページ
- 2025-06-22: 開発フロー・忘れやすいポイント追加（10占術実装完了時）
- 2025-06-21: 初版作成（仕様書設計完了時点）

## 🔄 型エラーループ防止の包括的手法

### 根本的解決アプローチ
**問題パターン**: 古いシステムから新システムへの移行時の型エラー
**包括的解決法**:
1. **完全削除→新規作成**: 段階的修正せず、完全削除してから新規実装
2. **型定義の一括更新**: 個別修正ではなく、関連する全型定義を同時更新  
3. **インポート文の完全置換**: 全参照箇所を特定し、一括置換実行
4. **テストファイルの同期更新**: 本体コードと同時にテストファイルも更新

### ループ回避の鉄則
- **個別修正禁止**: 1つのエラーだけ修正すると連鎖エラーが発生
- **包括的修正必須**: 関連する全ファイルを同時に修正  
- **検証の徹底**: 修正後は必ずtype-check, lint, buildを全実行

## 🚀 開発セッション開始時の必須フロー

### 1. 初期確認コマンド（コピペ用）
```bash
# プロジェクト状態の完全把握
pwd && echo "---" && \
cat CLAUDE.md | head -50 && echo "---" && \
ls -la docs/logs/$(date +%Y-%m)/ && echo "---" && \
git status && echo "---" && \
git log --oneline -5
```

### 2. 開発中の定期実行
```bash
# 品質チェック3点セット（エイリアス推奨）
npm run lint && npm run type-check && npm run build
```

### 3. 必須の確認事項
- [ ] TodoListの現状確認（TodoReadツール使用）
- [ ] 前回の開発ログ確認
- [ ] 環境変数の設定確認（.env.local）
- [ ] ターミナル表示は簡潔に（詳細は必要時のみ）

## 📝 繰り返し忘れやすいポイント

### 1. 品質チェックコマンド
**問題**: テストやビルドを忘れて後から問題発覚
**対策**: 変更後は必ず以下を実行
```bash
npm run lint        # リントチェック
npm run type-check  # 型チェック  
npm run build       # ビルド確認
npm test           # テスト実行
```

### 2. ターミナル表示の簡潔化
**問題**: 長大な出力でユーザーが読みづらい
**対策**: 
- 成功時：1行で報告
- エラー時：要点のみ抽出
- 詳細ログ：ユーザー要求時のみ

### 3. 並列実行の活用
**問題**: 逐次実行で時間がかかる
**対策**: Promise.allやツールの並列実行機能を活用
```typescript
// 良い例：並列実行
const results = await Promise.all([...]);
```

### 4. 開発ログの即時記録
**問題**: 後から思い出せない重要な決定
**対策**: 機能完成時・問題解決時に即記録

## 🔧 効率的な問題解決パターン

### エラー対処の優先順位
1. **型エラー** → 包括的アプローチで一括修正
2. **インポートエラー** → 依存関係の確認
3. **実行時エラー** → コンソールログで詳細確認
4. **テストエラー** → モック・環境設定の見直し

### デバッグの鉄則
- エラーメッセージを最後まで読む
- スタックトレースから原因を特定
- 推測より検証（console.log、型チェック）
- 小手先の修正より根本解決

## 🎯 MVP段階開発の必須原則

### コンテキスト制限（実証済み）
**32K tokens超過 = 性能劣化**: すべてのLLMで実証済み
- 29%成功率（32K以下） vs 3%成功率（256K）
- 10倍の性能差は技術的必然

### 効果的な指示方法
詳細は[CLAUDE_MVP_INSTRUCTION_GUIDE.md](docs/CLAUDE_MVP_INSTRUCTION_GUIDE.md)参照

**基本原則**:
1. 各段階を32K tokens以内に制限
2. 明確な境界で段階を分割
3. 各段階で完結した動作確認
4. 最小限の参照関係維持
